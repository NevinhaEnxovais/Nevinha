<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Vendas | Lista de Presentes</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        .container { max-width: 600px; margin: auto; }
        .search-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .search-container h3 { margin-top: 0; color: #1976d2; text-align: center; font-size: 18px; }
        .input-group { display: flex; gap: 8px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .btn-buscar { background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* TABELA DE LISTAS INICIAL */
        #painelInicial { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .tabela-resumo { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .tabela-resumo th { text-align: left; font-size: 12px; color: #777; padding: 8px; border-bottom: 2px solid #eee; }
        .tabela-resumo td { padding: 12px 8px; border-bottom: 1px solid #eee; font-size: 14px; cursor: pointer; }
        .tabela-resumo tr:hover { background: #f1f8ff; }
        .badge-id { background: #e3f2fd; color: #1976d2; padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; }

        .info-noivos { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #bbdefb; display: none; position: relative; }
        .btn-voltar { position: absolute; top: 5px; left: 5px; background: none; border: none; color: #1976d2; cursor: pointer; font-size: 12px; font-weight: bold; }
        
        #filtroItensContainer { display: none; margin-bottom: 15px; }
        .input-filtro { width: 100%; padding: 12px; border: 2px solid #1976d2; border-radius: 8px; box-sizing: border-box; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: white; border-radius: 10px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; position: relative; }
        .card img { width: 100%; height: 110px; object-fit: contain; margin-bottom: 10px; }
        .preco-prod { color: #2e7d32; font-weight: bold; margin: 8px 0; font-size: 16px; }
        .btn-venda { width: 100%; background: #4caf50; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .vendido-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; border-radius: 10px; }
        .vendido-texto { background: #d32f2f; color: white; padding: 5px 12px; border-radius: 4px; font-weight: bold; transform: rotate(-15deg); }
    </style>
</head>
<body>

<div class="container">
    <div class="search-container">
        <h3>üîç Localizar Lista</h3>
        <div class="input-group">
            <input type="text" id="idLista" placeholder="Digite o ID (Ex: 001)">
            <button class="btn-buscar" onclick="buscarLista()">ABRIR</button>
        </div>
    </div>

    <div id="painelInicial">
        <h4 style="margin:0; color:#1976d2">üìã Listas Ativas</h4>
        <table class="tabela-resumo">
            <thead><tr><th>ID</th><th>NOIVA</th><th>DATA</th></tr></thead>
            <tbody id="corpoTabela"></tbody>
        </table>
    </div>

    <div id="infoNoivos" class="info-noivos">
        <button class="btn-voltar" onclick="voltarParaInicio()">‚¨Ö VOLTAR</button>
        <h2 id="nomeDisplay" style="margin:0; font-size:18px"></h2>
        <p id="dataDisplay" style="margin:5px 0 0; font-size:14px; color:#1976d2"></p>
    </div>

    <div id="filtroItensContainer">
        <input type="text" id="inputFiltro" class="input-filtro" placeholder="üîé Pesquisar produto nesta lista..." onkeyup="filtrarProdutos()">
    </div>

    <div id="listaProdutos" class="grid"></div>
</div>

<script>
    const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbyk7IuILoIC3AgAfv5CHzkuzx1a4__LwvpVnymd7AEOWEcMKQrk42As5RMYhCZ-VEis/exec';

    window.onload = listarListasAtivas;

    async function listarListasAtivas() {
        const corpo = document.getElementById('corpoTabela');
        corpo.innerHTML = "<tr><td colspan='3' style='text-align:center'>Carregando listas...</td></tr>";
        try {
            const res = await fetch(`${URL_SCRIPT}?acao=listarAbas`);
            const listas = await res.json();
            corpo.innerHTML = "";
            listas.forEach(l => {
                const tr = document.createElement('tr');
                tr.onclick = () => { document.getElementById('idLista').value = l.id; buscarLista(); };
                tr.innerHTML = `<td><span class="badge-id">${l.id}</span></td><td><b>${l.noiva}</b></td><td><small>${l.data}</small></td>`;
                corpo.appendChild(tr);
            });
        } catch (e) { corpo.innerHTML = "<tr><td colspan='3'>Erro ao carregar.</td></tr>"; }
    }

    async function buscarLista() {
        const id = document.getElementById('idLista').value.trim();
        if(!id) return;
        document.getElementById('painelInicial').style.display = 'none';
        const container = document.getElementById('listaProdutos');
        const infoNoivos = document.getElementById('infoNoivos');
        const filtro = document.getElementById('filtroItensContainer');
        container.innerHTML = "Carregando produtos...";

        try {
            const res = await fetch(`${URL_SCRIPT}?acao=buscar&lista=${id}`);
            const dados = await res.json();
            if(dados.length > 0) {
                const noiva = (dados[0][7] || "").replace("Noiva: ", "");
                const noivo = (dados[1][7] || "").replace("Noivo: ", "");
                const data = (dados[2][7] || "").replace("Data: ", "");
                document.getElementById('nomeDisplay').innerText = `${noiva} ${noivo ? '& ' + noivo : ''}`;
                document.getElementById('dataDisplay').innerText = data ? `Evento: ${data}` : "";
                infoNoivos.style.display = "block";
                filtro.style.display = "block";
            }
            container.innerHTML = "";
            for(let i = 1; i < dados.length; i++) {
                if(!dados[i][1]) continue;
                const status = dados[i][5]; 
                const card = document.createElement('div');
                card.className = 'card';
                card.setAttribute('data-nome', dados[i][1].toLowerCase());
                card.innerHTML = `<img src="${dados[i][6] || 'https://via.placeholder.com/150'}"><div style="font-size:12px; font-weight:bold; height:32px; overflow:hidden">${dados[i][1]}</div><div class="preco-prod">R$ ${dados[i][2]}</div><button class="btn-venda" onclick="confirmarVenda('${id}', '${dados[i][0]}')" ${status === 'Vendido' ? 'disabled' : ''}>${status === 'Vendido' ? 'VENDIDO' : 'VENDER'}</button>${status === 'Vendido' ? '<div class="vendido-overlay"><div class="vendido-texto">VENDIDO</div></div>' : ''}`;
                container.appendChild(card);
            }
        } catch (e) { container.innerHTML = "Lista n√£o encontrada."; }
    }

    function filtrarProdutos() {
        const termo = document.getElementById('inputFiltro').value.toLowerCase();
        document.querySelectorAll('.card').forEach(card => {
            card.style.display = card.getAttribute('data-nome').includes(termo) ? "block" : "none";
        });
    }

    function voltarParaInicio() {
        document.getElementById('painelInicial').style.display = 'block';
        document.getElementById('infoNoivos').style.display = 'none';
        document.getElementById('filtroItensContainer').style.display = 'none';
        document.getElementById('listaProdutos').innerHTML = '';
        document.getElementById('idLista').value = '';
        listarListasAtivas();
    }

    async function confirmarVenda(aba, idProd) {
        if(!confirm("Confirmar venda?")) return;
        await fetch(`${URL_SCRIPT}?acao=vender&lista=${aba}&id=${idProd}`);
        buscarLista(); 
    }
</script>
</body>
</html>